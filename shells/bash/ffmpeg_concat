#!/bin/bash
# SPDX-License-Identifier: GPL-3.0-only

ffmpeg_concat() (
    err() {
        trap - INT TERM EXIT

        if [ "$1" != 0 ]; then
            printf "%s" \
'
$1 -> input 1
$2 -> input 2
$3 -> fname
$4 *a* -> out PTS/DTS as-is (might choke players)
$4 *d* -> `-loglevel debug`
$4 *i* -> `-map_metadata 1` (global metadata from input 2 instead of 1)
$4 *m* -> dont keep mtime
$4 *n* -> keep mtime of input 2
$4 *t* -> keep in tmp dir, no cleanup
$4 *u* -> work in current dir
'

            rm -rf "${TMPDIR:-/tmp}"/ffmpeg_concat
        fi

        case "$OPTS" in
            *u*) rm -rf "$DIR"/.ffmpeg_concat ;;
            *t*) : ;;
            *) rm -rf "${TMPDIR:-/tmp}"/ffmpeg_concat ;;
        esac

        exit "$1"
    }

    set -e
    trap "err \$?" INT TERM EXIT

    IN="$1"
    IN2="$2"
    FNAME="$3"
    OPTS="$4"
    DIR=$(cd -Pe "$PWD" && printf "%s" "${PWD}x")
    DIR="${DIR%?}"

    [ "$IN" ] || { printf "%s\n" 'No input file specified.'; exit 2; }
    [ -e "$IN" ] || { printf "%s\n" 'Bad input. (ENOENT)'; exit 2; }
    [ ! -d "$IN" ] || { printf "%s\n" 'Bad input. (EISDIR)'; exit 2; }

    case "$IN" in
        */*)
            IN="$(realpath -- "$IN" && printf "%s" x)"
            IN="${IN%??}"

            DIR="${IN%/*}"
        ;;
        *)
            IN="$DIR"/"$IN"
        ;;
    esac

    [ -e "$IN" ] || { printf "%s\n" 'Resolution error. (ENOENT)'; exit 1; }

    [ "$IN2" ] || { printf "%s\n" 'No second file specified.'; exit 2; }
    [ -e "$IN2" ] || { printf "%s\n" 'Bad second file. (ENOENT)'; exit 2; }
    [ ! -d "$IN2" ] || { printf "%s\n" 'Bad second file. (EISDIR)'; exit 2; }

    IN2="$(realpath -- "$IN2" && printf "%s" x)"
    IN2="${IN2%??}"

    [ -e "$IN2" ] || { printf "%s\n" 'Resolution error. (ENOENT)'; exit 1; }

    case "$FNAME" in
        *.???) FNAME="${FNAME%????}" ;;
        *.????) FNAME="${FNAME%?????}" ;;
    esac

    case "$OPTS" in
        *u*)
            # custom empty dir is still needed; otherwise the glob match cannot
            # be trusted
            mkdir "$DIR"/.ffmpeg_concat
            cd "$DIR"/.ffmpeg_concat
        ;;
        *)
            rm -rf "${TMPDIR:-/tmp}"/ffmpeg_concat
            mkdir "${TMPDIR:-/tmp}"/ffmpeg_concat
            cd "${TMPDIR:-/tmp}"/ffmpeg_concat
        ;;
    esac

    ShePoludeem=$(
        printf "file '%s'\n" "${IN//\'/\'\\\'\'}"
        printf "file '%s'\n" "${IN2//\'/\'\\\'\'}"
    )
    printf "%s" "$ShePoludeem" > ShePoludeem.txt

    set -- 'ffmpeg'
    set -- "$@" '-hide_banner'

    # fully regenerate PTS/DTS container timestamps by default for monotonic
    # timeline. a timeline that is not monotonic can choke players.
    #
    # in either case, PTS/DTS do not affect the produced video/audio (packet)
    # data; only the container's PTS/DTS get regenerated when not re-encoding
    # (and `+genpts` will *not* force re-encode).
    #
    # if source PTS/DTS are 100% correct, `+genpts` is redundant but harmless.
    case "$OPTS" in
        *a*)
            set -- "$@" '-avoid_negative_ts' 'disabled'  # 0
        ;;
        *)
            set -- "$@" '-fflags' '+genpts'
        ;;
    esac

    set -- "$@" '-f' 'concat'
    set -- "$@" '-safe' '0'
    set -- "$@" '-i' 'ShePoludeem.txt'  # kaam ti
    set -- "$@" '-c' 'copy'
    set -- "$@" '-map' '0'

    case "$OPTS" in
        *i*) set -- "$@" '-map_metadata' '1' ;;
    esac

    case "$OPTS" in
        *d*) set -- "$@" '-loglevel' 'debug' ;;
    esac

    set -- "$@" "${IN##*/}"

    "$@"

    rm -f ShePoludeem.txt  # (poludqvam)

    FILE=$(set -- *; printf "%s" "${1}x")
    FILE="${FILE%?}"

    case "$OPTS" in
        *m*) : ;;
        *n*) touch -r "$IN2" "$FILE" ;;
        *) touch -r "$IN" "$FILE" ;;
    esac

    if [ "$FNAME" ]; then
        case "$FILE" in
            *.??? | *.????)
                mv "$FILE" "${FNAME}.${FILE##*.}"

                FILE="${FNAME}.${FILE##*.}"
            ;;
            *)
                mv "$FILE" "$FNAME"

                FILE="$FNAME"
            ;;
        esac
    fi

    case "$OPTS" in
        *u*)
            mv "$FILE" "$DIR"/"$FILE"

            printf "%b%s%b %b%s%b\n" \
                '\033[1;32m' 'FILE:' '\033[0m' \
                '\033[1;37m' "$DIR"/"$FILE" '\033[0m'
        ;;
        *t*)
            printf "%b%s%b %b%s%b\n" \
                '\033[1;32m' 'FILE:' '\033[0m' \
                '\033[1;37m' "${TMPDIR:-/tmp}"/ffmpeg_concat/"$FILE" '\033[0m'
        ;;
        *)
            mv -f "${TMPDIR:-/tmp}"/ffmpeg_concat/"$FILE" "$DIR"/"$FILE"

            printf "%b%s%b %b%s%b\n" \
                '\033[1;32m' 'FILE:' '\033[0m' \
                '\033[1;37m' "$DIR"/"$FILE" '\033[0m'
        ;;
    esac
)

ffmpeg_concat "$@"
